rule("Reset menu positions (trigger: game start || num of allowed heroes changed)") {
	event {
		ongoing - each player;
		all;
		all;
	}
	
	actions {
		set player variable(event player, P, empty array);
	}
	
	conditions {
		count of(player variable(event player, P)) != count of(allowed heroes(event player));
	}
}

rule("Init menu item positions, num == 2 (PV_P[] = item_positions, PV_T once)") {
	event {
		ongoing - each player;
		all;
		all;
	}
	
	actions {
		set player variable at index(event player, P, 0, vector(sine from degrees(-90), cosine from degrees(-90), 0));
		set player variable at index(event player, P, 1, vector(sine from degrees(90), cosine from degrees(90), 0));
	}
	
	conditions {
		player variable(event player, P) == empty array;
		count of(allowed heroes(event player)) == 2;
	}
}

rule("Init menu item positions, num > 2 (PV_P[] = item_positions, PV_T once)") {
	event {
		ongoing - each player;
		all;
		all;
	}
	
	actions {
		set player variable at index(event player, P, player variable(event player, T), vector(sine from degrees(multiply(player variable(event player, T), divide(360, count of(allowed heroes(event player))))), cosine from degrees(multiply(player variable(event player, T), divide(360, count of(allowed heroes(event player))))), 0));
		modify player variable(event player, T, add, 1);
		wait(0.016, ignore condition);
		loop if(compare(player variable(event player, T), <, count of(allowed heroes(event player))));
	}
	
	conditions {
		player variable(event player, P) == empty array;
		count of(allowed heroes(event player)) > 2;
	}
}

rule("Init menu icons (GV_T once)") {
	event {
		ongoing - each player;
		all;
		all;
	}
	
	actions {
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 0)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 0), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 2));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 1)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 1), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 3));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 2)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 2), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 4));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 3)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 3), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 5));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 4)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 4), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 6));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 5)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 5), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 7));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 6)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 6), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 8));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 7)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 7), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 9));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 8)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 8), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 10));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 9)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 9), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 11));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 10)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 10), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 12));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 11)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 11), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 13));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 12)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 12), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 14));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 13)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 13), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 15));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 14)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 14), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 16));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 15)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 15), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 17));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 16)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 16), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 18));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 17)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 17), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 19));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 18)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 18), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 20));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 19)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 19), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 21));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 20)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 20), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 22));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 21)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 21), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 23));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 22)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 22), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 24));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 23)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 23), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 25));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 24)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 24), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 26));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 25)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 25), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 27));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 26)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 26), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 28));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 27)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 27), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 29));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 28)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 28), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
		abort if(compare(count of(allowed heroes(event player)), <, 30));
		wait(0.03, ignore condition);
		create in-world text(filtered array(event player, compare(player variable(event player, R), >=, 0.1)), hero icon string(value in array(allowed heroes(event player), 29)), world vector of(add(add(local vector of(player variable(event player, A), event player, rotation), multiply(value in array(player variable(event player, P), 29), player variable(event player, R))), vector(0, -0.15, 0)), event player, rotation), 2.5, do not clip, visible to position and string);
	}
	
	conditions {
		player variable(event player, A) != 0;
		count of(player variable(event player, P)) > 0;
	}
}

rule("Open menu (PV_A = menu_center)") {
	event {
		ongoing - each player;
		all;
		all;
	}
	
	actions {
		set player variable(event player, A, add(eye position(event player), multiply(2, direction from angles(horizontal facing angle of(event player), min(40, max(-40, vertical facing angle of(event player)))))));
		set player variable(event player, R, 0.1);
		chase player variable over time(event player, R, add(0.2, multiply(0.028, count of(allowed heroes(event player)))), 0.2, destination and duration);
	}
	
	conditions {
		is button held(event player, interact) == true;
		player variable(event player, R) == 0;
	}
}

rule("Close menu") {
	event {
		ongoing - each player;
		all;
		all;
	}
	
	actions {
		chase player variable over time(event player, R, 0, 0.1, destination and duration);
	}
	
	conditions {
		is button held(event player, interact) == false;
		player variable(event player, R) > 0;
	}
}

rule("Select menu item (PV_T = selected_item_idx)") {
	event {
		ongoing - each player;
		all;
		all;
	}
	
	actions {
		set player variable(event player, T, index of array value(player variable(event player, P), first of(filtered array(player variable(event player, P), compare(multiply(10, dot product(facing direction of(event player), direction towards(eye position(event player), world vector of(add(local vector of(player variable(event player, A), event player, rotation), multiply(current array element, player variable(event player, R))), event player, rotation)))), >=, 9.98)))));
		start forcing player to be hero(event player, value in array(allowed heroes(event player), player variable(event player, T)));
		stop forcing player to be hero(event player);
	}
	
	conditions {
		is button held(event player, interact) == false;
		player variable(event player, R) >= 0.2;
	}
}

